#################################################################################################
#This script check enrollment and build or adjust VM pools for classes that are marked as Virtual classes
#Any enrollment in a virtual class and a pool will be built. 
#Additional enrollments and the script will adjust the pool to the proper number


Start-Transcript -Path "C:\Scripts\CreateVMPools.txt" -Append -Force

Add-PSSnapin Vmware.view.broker
Import-Module "C:\Scripts\FunctionsModules\Set-BCPoolHTMLAccess.ps1" -Verbose
Import-Module "C:\Scripts\FunctionsModules\Set-PoolBlackoutTimes.ps1" -Verbose 
Import-Module "C:\Scripts\FunctionsModules\Set-PoolStorageAcceleratorDisks.ps1"
Import-Module "C:\Scripts\FunctionsModules\Enable-PoolStorageAccelerator.ps1" -Verbose
Import-Module "C:\Scripts\FunctionsModules\Set-PoolPageSharing.ps1" -Verbose
Import-Module "C:\Scripts\FunctionsModules\Set-PoolReuseFlag.ps1" -Verbose
Import-Module "C:\Scripts\FunctionsModules\Set-PoolDisplay.ps1" -Verbose
Import-Module ActiveDirectory

Disconnect-VIServer -Confirm:$false
Connect-VIServer [VCENTER]

####################use this to find number of VMs running on a host##########################
$vms = Get-VM -Name 'PCS*' | Sort-Object -Property name

#########Holder to count number of VMs on each host
$lab3 = 0
$lab2 = 0

foreach ($vm in $vms)
{
    if($vm.Powerstate -eq "PoweredOn" -or $vm.PowerState -eq "Suspended")
    {
        switch($vm.VMHost){
        'lab3'{$lab3++}
        'lab2'{$lab2++}
        }
    }
}
##############Assign target host for new pool############
$targetHost = Get-VMHost -Name lab3   #lab3 is default host unless it has more VMs than lab2
if($lab3 -gt $lab2)
{
    $targetHost = Get-VMHost -Name lab2  
}

if($targetHost.ConnectionState -ne 'Connected')
{
    Write-Output "Target host is in maintenance mode - EXITING"
    exit
}

$OU = "[USEROU]" # does not change

#Collects users that are in DL IT classes that use VMs, and CR students that use VMs that are between a week before assigned start date and 2 days past end date
$DBServer="DB1"
$DB="[DB]"
$Query_SQL="SELECT  CourseID + SectionID as ID,
                    CourseID,
                    SectionID,
                    CourseTitle,
                    StartDate,
                    EndDate,
                    TotalEnroll,
                    BranchID,
                    Instructor
                    FROM vPDClassroomEnrollment 
                    WHERE (CAST(CURRENT_TIMESTAMP AS DATE) BETWEEN DATEADD(d,-7,CAST(StartDate AS DATE)) AND DATEADD(d,1,CAST(EndDate AS DATE)) AND  Virtual = 1) "   

                                      
                    

$conn_SQL=New-Object system.data.sqlclient.sqlconnection("Server=$DBServer;Database=$DB;Integrated Security=True") 
$da_SQL=New-Object system.data.sqlclient.sqldataadapter($Query_SQL,$conn_SQL)
$dt_SQL=New-Object system.data.datatable

#try the SQL connection if error then exit the script
try
{
    $conn_SQL.Open()
    [void]$da_SQL.fill($dt_SQL)
    $conn_SQL.Close() 
}
catch
{
    Write-Output "Connect failed"
    exit
}

#add a test class manually
<#
$newRow=$dt_SQL.NewRow()
$newRow.ID="MP2013_1C2118019"
$newRow.CourseID="MP2013_1"
$newRow.SectionID="C2118019"
$newRow.CourseTitle="MICROSOFT POWERPOINT 2013 Essentials"
$newRow.StartDate="9/13/2017"
$newRow.EndDate="9/13/2017"
$newRow.TotalEnroll="3"
$newRow.BranchID="1"
$newRow.Instructor="Susan Steinhauser"
$dt_SQL.Rows.Add($newRow)

$newRow=$dt_SQL.NewRow()
$newRow.ID="ZZTESTZZZ1234"
$newRow.CourseID="ZZTEST"
$newRow.SectionID="ZZZ1234"
$newRow.CourseTitle="MICROSOFT ACCESS TEST CLASS"
$newRow.StartDate="8/9/17"
$newRow.EndDate="8/17/17"
$newRow.TotalEnroll="3"
$newRow.BranchID="1"
$newRow.Instructor="Brian Schmid"
$dt_SQL.Rows.Add($newRow) 
#>

$dt_SQL.primarykey=$dt_SQL.columns[0]
#assign table of current classes to array
$Classes=$dt_SQL.Rows 

#get current pools for classes
$pools = Get-Pool -PoolType SviPersistent | Where-Object {$_.pool_id -notlike "*dl"}
foreach($class in $classes)
{
    Write-Output "Checking -- "$class.CourseTitle
    #if class has enough enrollment to create pool
    if($class.TotalEnroll -gt 2)
    {
        Write-Output "Students Enrolled -- " $class.TotalEnroll 
        #search for existing pools for classes with enrollment
        foreach($pool in $pools)
        {
            Write-Output "Comparing with pool -- " $pool.displayName
            #compare the courseID to the poolID
            if($pool.pool_id -like ($class.CourseID.Substring(0, 2) + "*"))
            {
                Write-Output "Match on -- " $pool.pool_id
                #set new max VM count for existing class if enrollment is over VM count
                if(($class.TotalEnroll + 1) -gt $pool.maximumCount)
                {
                    Write-Output "Updating pool -- " $pool.displayName
                    Update-AutomaticLinkedClonePool -Pool_id $pool.pool_id -MaximumCount ($class.TotalEnroll + 1) -MinimumCount ($class.TotalEnroll + 1) -Verbose
                }
            }
        }
            
            #the above loop will kick the class object to here for every non match. 
            #Condition here will stop the creation of the pool again if it has already been created in a previous iteration of the following loop or in a previous script run
            if(!(Get-Pool -DisplayName $class.CourseTitle -ErrorAction SilentlyContinue))
            {
                #no existing pool found - create new pool
                Write-Output "Starting pool creation for -- " $class.CourseID 
                if($class.CourseTitle -like "*2016*")
                {
                    $poolOS = "W100"
                }
                else
                {
                    $poolOS = "W63"
                    
                }

                Switch -wildcard ($class.CourseTitle.ToUpper())
                {
                    "MICROSOFT ACCESS*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\access_prep.bat" ;$ClassType="Access"; break}
                    "MICROSOFT EXCEL*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\excel_prep.bat" ; $ClassType="Excel"; break}
                    "MICROSOFT WORD*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\word_prep.bat" ;$ClassType="Word";  break}
                    "MICROSOFT OUTLOOK*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\outlook_prep.bat" ;$ClassType="Outlook"; break}
                    "MICROSOFT POWERPOINT*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\powerpoint_prep.bat" ;$ClassType="PowerPoint"; break}
                    "*MICROSOFT PROJECT*" {$VDGName = "VDG" + $poolOS + "O1"; $postSyncScript = "C:\scripts\project_prep.bat" ; $ClassType="Project";break}
                    "USING MICROSOFT SHAREPOINT*" {$VDGName = "VDG" + $poolOS + "O1" ; $postSyncScript = "C:\scripts\sharepoint_prep.bat" ; $ClassType="Sharepoint"; break}
                    "*JAVA*" {$VDGName = "VDG" + $poolOS + "JAVA" ;$postSyncScript = "" ; $ClassType="Java";  break}
                    "*C++*" {$VDGName = "VDG" + $poolOS + "CPP" ;$postSyncScript = "C:\scripts\cpp_prep.bat" ;$ClassType="CPP";  break}
                    #"*PHOTOSHOP*" {$VDGName = "VDG" + $poolOS + "" ;$ClassType="PhotoShop"; break}
                    "*SKETCHUP*" {$VDGName = "VDG" + $poolOS + "SKETCH" ;$postSyncScript = "C:\scripts\sketchup_prep.bat" ;$ClassType="SketchUp"; break}
                    "QUICKBOOKS*" {$VDGName = "VDG" + $poolOS + "QB" ; $postSyncScript = "" ; $ClassType="QuickBooks"; break}
                    "*MATLAB*" {$VDGName = "VDG" + $poolOS + "MATLAB" ; $postSyncScript = "C:\scripts\matlab_prep.bat" ;$ClassType="MatLab"; break}
                    "*DOORS*" {$VDGName = "VDG" + $poolOS + "DOORS" ; $postSyncScript = "" ;$ClassType="DOORS"; break}
                    "*SYSML*" {$VDGName = "VDG" + $poolOS + "CAMEO" ; $postSyncScript = "" ; $ClassType="Magic Draw"; break}
                    "Network+*" {$VDGName = "VDG" + $poolOS + "NET" ; $postSyncScript = "" ;$ClassType="Cert"; break}
                    #"Security+*" {$VDGName = "VDG" + $poolOS + "" ; $ClassType="Cert"; break}
                    "*PYTHON*" {$VDGName = "VDG" + $poolOS + "PYTHON" ; $postSyncScript = "C:\scripts\python_prep.bat" ; $ClassType="Python"; break}
                    default {$VDGName = "VDGW100O16" ; $postSyncScript = "C:\scripts\office_prep.bat" ;break}
                }

                #get correct VDG or group of VDGs
                $VDGObj = Get-VM -Name "VDG*" | Where-Object {$_.Name -like ($VDGName + "*") -and $_.Name -notlike "*OLD*"} | Select-Object * | Sort-Object -Property Name
                Write-Output "Gold Disc assigned --" $VDGObj[$VDGObj.Count - 1].Name

               <#  if($VDGObj.Count > 1)
                {
                    #will get the latest HW version of multiple found VDGs
                    #VDG names need v10, v11, etc appended to the end
                    $VDGObj = $VDGObj | Sort-Object -Property Name
                    $VDGObj = $VDGObj[$VDGObj.Count - 1]
                } #>

                #assign path to most current VDG - using $VDGObj[$VDGObj.Count - 1] after sort points to highest HW ver
                $parentVMPath = "/PCS Virtual Desktops/vm/" + $VDGObj[$VDGObj.Count - 1].Folder + "/" + $VDGObj[$VDGObj.Count - 1].Name
                Write-Output "Parent VM path -- " $parentVMPath

                #get snapshots for VDG
                $snapObj = Get-Snapshot -VM $VDGObj[$VDGObj.Count - 1].name | Sort-Object name
                Write-Output "Sanpshot assigned -- " $VDGObj[$VDGObj.Count - 1].name
                $parentSnapPath  = ""

                #builds path to SS
                foreach($snap in $snapObj)
                {
                    #build root path
                    #Write-Host "Snap   " $snap.ParentSnapshot.Name
                    #Write-Host "ParentsnapPath   " $parentSnapPath
                    $parentSnapPath  = $parentSnapPath +$snap.ParentSnapshot.Name + "/"
                    if($snap -eq $snapObj[$snapObj.Count - 1])
                    {
                        #add on name of SS to path
                        $parentSnapPath  = $parentSnapPath + $snap.Name
                        Write-Output "ParentsnapPath -- " $parentSnapPath
                    }
                }
                
                #assign resource pool - same as host
                $resourcePoolPath = "/PCS Virtual Desktops/host/" + $targetHost.Name + "/Resources"
                Write-Output "Resources pool path -- " $resourcePoolPath
                #assigns datastore for OS
                $OSStorage = Get-Datastore -RelatedObject $targetHost -Name "*_OS_*"
                Write-Output "OS Storage Disk -- " $OSStorage.Name
                #datastore for persistent disc
                $persistentStorage = Get-Datastore -RelatedObject $targetHost -Name "*_Per*"
                Write-Output "Persistent Disk -- " $persistentStorage.Name
                #datastore specs
                $dataStoreSpecs = "[Aggressive,data]/PCS Virtual Desktops/host/" + $targetHost.Name + "/" + $persistentStorage.name + ";[Aggressive,OS]/PCS Virtual Desktops/host/" + $targetHost.Name + "/" + $OSStorage
                Write-Output "Data store specs -- " $dataStoreSpecs
                #name of clones will be the same as the CourseID
                $namePrefix = "PCS" + $class.CourseID + "{n:fixed=2}"
                Write-Output "Name prefix -- " $namePrefix
                $description = "Pool created by CreateNewPoolfromXen script on " + (Get-Date).ToString()
                Write-Output "Description -- " $description
                
                    
                Add-AutomaticLinkedClonePool -Pool_id $class.CourseID `
                                             -DisplayName $class.CourseTitle `
                                             -Vc_id 'fa56cb89-bf14-450a-bc59-644e9872c2cd' `
                                             -FolderId 'Class pools' `
                                             -Persistence Persistent `
                                             -VmFolderPath "/PCS Virtual Desktops/vm/LinkedClones" `
                                             -ResourcePoolPath $resourcePoolPath `
                                             -ParentVmPath $parentVMPath `
                                             -ParentSnapshotPath $parentSnapPath `
                                             -DatastoreSpecs $dataStoreSpecs `
                                             -Composer_ad_id 'f1b72e8f-9c63-46fa-8da0-011bfba047ab' `
                                             -OrganizationalUnit 'OU=Virtual,OU=Desktops,OU=Labs,OU=Labs and Classrooms' `
                                             -PostSyncScript $postSyncScript `
                                             -MinimumCount ($class.TotalEnroll + 1) `
                                             -MaximumCount ($class.TotalEnroll + 1) `
                                             -RefreshPolicyType Never `
                                             -NamePrefix $namePrefix `
                                             -PowerPolicy Suspend `
                                             -IsUserResetAllowed $true `
                                             -SuspendProvisioningOnError $true `
                                             -AutoLogoffTime 120 `
                                             -DefaultProtocol PCOIP `
                                             <#-AllowMultipleSessions $false #> `
                                             -AllowProtocolOverride $false `
                                             -FlashQuality NO_CONTROL `
                                             -FlashThrottling DISABLED `
                                             -IsProvisioningEnabled $false `
                                             -UseUserDataDisk $true `
                                             -DataDiskLetter D `
                                             -DataDiskSize 2048 `
                                             -UseTempDisk $true `
                                             -TempDiskSize 4096 `
                                             -Description $description `
                                             -UseSeSparseDiskFormat $true `
                                             -HeadroomCount 1 `
                                             -SeSparseThreshold 0 `
                                             -Verbose
                    Write-Output "Starting sleep 180"
                    Start-Sleep -Seconds 180 -Verbose

                    $EntitleIns = Get-ADUser -Filter * -SearchBase "[INSTRUCTOR]" | Where-Object {$_.Name.Contains($class.Instructor)}
                    $EntitleGroup = Get-ADGroup -Filter * -SearchBase "[STUDENTSOU]" | Where-Object {$_.Name.Contains($ClassType + " Students")}
                    Add-PoolEntitlement -Pool_id $class.CourseID -Sid $EntitleGroup.SID -Verbose
                    Add-PoolEntitlement -Pool_id $class.CourseID -Sid $EntitleIns.SID -Verbose

                    Write-Output "Starting final config"
                    Set-BCPoolHtmlAccess -Pool_id $class.CourseID -HtmlAccess $true 
                    Set-PoolReuseFlag -Pool_id $class.CourseID -ReuseFlag $true
                    Set-PoolBlackoutTimes -Pool_id $class.CourseID -StartTime "07:00" -StopTime "23:00" -days 1,2,3,4,5
                    Set-PoolPageSharing -Pool_Id $class.CourseID -Flag GLOBAL
                    Enable-PoolStorageAccelerator -Pool_id $class.CourseID -Flag $true
                    Set-PoolStorageAcceleratorDisks -Pool_id $class.CourseID -UDDisk $true
                    Set-PoolDisplay -Pool_Id $class.CourseID -numDisplays 1
                    #####Change all the other stuff
                    
                    ####have pool create with provisioning disabled - re-eanble after last changes are made
                    Update-AutomaticLinkedClonePool -Pool_id $class.CourseID -IsProvisioningEnabled $true -Verbose

                                                                                
                }
         
     }
}
Stop-Transcript
    
